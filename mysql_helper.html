<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>MYSQL_WHERE_IN_去掉换行符(列转行)</title>
    <style type="text/css">
        .conditionText {
            width: 1000px;
            height: 500px;
        }

        button {
            height: 50px;
            display: block;
            margin-top: 10px;
            width: 1000px;
        }

        p {
            margin: 0;
            padding: 0
        }

        #tips {
            font-size: 12px;
            color: #999;
            margin: 10px 0;
        }

        #result {
        }

        #result .rsWrap {
            margin: 10px 0;
            background: aliceblue;
        }

        #result .rsWrap .rsLen {
            padding: 10px 0;
            font-size: 14px;
            color: #999;
        }

        #result .rsWrap .rsContent {
            white-space: nowrap;
            padding-bottom: 10px;
            font-size: 16px;
            color: #000;
        }

        .none {
            display: none
        }

        #magicBox {
            padding: 10px 50px;
            background: whitesmoke;
            margin: 10px 0;
        }

        #magicTitle {
            margin: 10px 0;
        }

        #magicBox p {
            margin-bottom: 5px;
        }

        #magicBox .textBox {
            width: 1000px;
            height: 50px;
        }

        #magicNum {
            width: 1000px;
            height: 30px;
            text-align: center;
            margin-bottom: 10px;
        }

    </style>
</head>
<body>
<div id="container">
    <h3>MYSQL_WHERE_IN_去掉换行符(列转行)</h3>
    <textarea class="conditionText" placeholder="源数据为列类型
如
106873O19050704439680
106873O19050889570315
106873O19051061114684
106873O19051061116360
106873O19051061118893
106873O19051138701262
106873O19051138702715
106873O19051138704386
106873O19051138705671

转换之后为
106873O19050704439680,106873O19050889570315,106873O19051061114684,106873O19051061116360,106873O19051061118893,106873O19051138701262,106873O19051138702715,106873O19051138704386,106873O19051138705671

勾选字符串类型,转换之后为
'106873O19050704439680','106873O19050889570315','106873O19051061114684','106873O19051061116360','106873O19051061118893','106873O19051138701262','106873O19051138702715','106873O19051138704386','106873O19051138705671'
" id="input"></textarea>
    <br>
    <div><input id="isStr" type="checkbox">字符串类型</div>
    <div><input id="isUnique" type="checkbox">去重</div>
    <div><input id="isMagic" type="checkbox">魔法</div>
    <div class="magicBox none" id="magicBox">
        <div id="magicTitle"><b>魔法</b>：根据指定的前缀后缀按指定分组数转换为多个UNION ALL字句(当WHERE IN过多时MYSQL会走全表扫描，这种方式某些情况下可以规避全表扫描)
            <br>
            <b>警告：</b>使用时请注意查询数据量，表数据量大小，以及数据库负载能力
        </div>
        <p>前缀:</p>
        <textarea placeholder="前缀" id="magicPrefix" class="textBox">SELECT * FROM tableName WHERE field IN (</textarea>
        <p>后缀:</p>
        <textarea placeholder="后缀" id="magicSubfix" class="textBox">)</textarea>
        <p>每组数量:</p>
        <select id="magicNum">
            <option value="10">10条</option>
            <option value="50">50条</option>
            <option value="100">100条</option>
            <option value="500">500条</option>
            <option value="1000">1000条</option>
            <option value="2000">2000条</option>
            <option value="5000">5000条</option>
            <option value="10000">10000条</option>
        </select>
    </div>
    <button id="btn">转</button>
    <div id="tips">
        <p>1.会自动过滤头尾空格，点击'转'按钮后结果出现在下方，请三击鼠标左键全选整行</p>
        <p>2.去重：去除重复元素</p>
        <p>3.字符串类型: 元素前尾会加上单引号</p>
    </div>
    <div id="result"></div>
</div>
<script type="text/javascript">
    /**
     * MYSQL_WHERE_IN_去掉换行符(列转行)
     * by lzs
     * 2019/11/21
     */
    document.getElementById("btn").addEventListener('click', handler);
    document.getElementById("isMagic").addEventListener('change', onIsMagicChangeHandler);

    // dom
    let inputDom = document.getElementById('input');
    let isStrDom = document.getElementById('isStr');
    let isUniqueDom = document.getElementById('isUnique');
    let isMagicDom = document.getElementById('isMagic');
    let resultDom = document.getElementById('result');
    let containerDom = document.getElementById('container');
    let magicBoxDom = document.getElementById('magicBox');
    let magicPrefixDom = document.getElementById('magicPrefix');
    let magicSubfixDom = document.getElementById('magicSubfix');
    let magicNumDom = document.getElementById('magicNum');
    const MAGIC_SPA = 'UNION ALL';

    // 转换处理
    function handler() {
        try {
            let val = inputDom.value;
            let isStr = isStrDom.checked;
            let isUnique = isUniqueDom.checked;
            let isMagic = isMagicDom.checked;
            let magicNum = parseInt(magicNumDom.value);

            // 去掉首尾空格
            val = val ? val.trim() : '';

            if (!val) {
                return;
            }

            // 分割换行符
            let regexp = /[\r\n]/g;
            let arr = val.split(regexp);
            arr = isUnique ? unique(arr) : arr;

            let result = isMagic ? magic(magicPrefixDom.value, magicSubfixDom.value, arr, magicNum, isStr) : concatSpa(arr, isStr);

            appendHTML(resultDom, arr.length, result, isStr, isUnique, isMagic, magicNum);
        } catch (e) {
            err(e);
        }
    }

    // 魔法checkbox change处理
    function onIsMagicChangeHandler() {
        magicBoxDom.style.display = this.checked ? "block" : "none";
    }

    // 错误输出
    function err(str) {
        alert(str);
    }

    // 获取spa
    function getSpa(isStr) {
        return isStr ? "','" : ",";
    }

    // 数组拼接逗号
    function concatSpa(arr, isStr) {
        if (arr.length <= 0) {
            return '';
        }
        let result = arr.join(getSpa(isStr));

        if (isStr) {
            result = "'" + result + "'";
        }
        return result;
    }

    // 魔法
    function magic(prefix, subfix, conditionArr, groupNum, isStr) {
        groupNum = parseInt(groupNum);

        let result = '';
        if (!(prefix && subfix)) {
            throw new Error("魔法必须要有前缀后缀");
        }

        if (groupNum <= 0) {
            throw new Error("魔法分组数量必须大于0");
        }

        if (!(Array.isArray(conditionArr) && conditionArr.length > 0)) {
            return result;
        }

        // 分组操作
        let start = 0;
        let end = groupNum;
        let chunkArr = [];
        let chunkResultArr = [];
        do {
            chunkArr = conditionArr.slice(start, end);
            if (!chunkArr || chunkArr.length <= 0) {
                break;
            }
            chunkResultArr.push(prefix + concatSpa(chunkArr, isStr) + subfix);
            start = end;
            end += groupNum;
        } while (true);

        result = chunkResultArr.join(' ' + MAGIC_SPA + ' ')

        return result;
    }

    // 显示HTML到页面
    function appendHTML(dom, len, content, isStr, isUnique, isMagic, magicNum) {
        let isStrDesc = isStr ? '[字符串类型]' : '[非字符串类型]';
        let isUniqueDesc = isUnique ? '[去重]' : '[不去重]';
        let timeDesc = '[' + getNow() + ']';
        let lenDesc = '数据总条数：' + len;
        let groupDesc = isMagic ? '共' + Math.ceil(len / magicNum)  + '组': '';
        let html = `<div class="rsWrap"><p class="rsLen">${timeDesc} ${isStrDesc} ${isUniqueDesc} ${lenDesc} ${groupDesc}</p><p class="rsContent">${content}</p></div>`;
        dom.innerHTML += html;
        scrollToBottom(containerDom);
    }

    // 滑动到底部
    function scrollToBottom(dom) {
        scrollTo(0, document.body.scrollHeight);
        dom.scrollTop = dom.scrollHeight;
    }

    // 获取当前时间
    function getNow() {
        let d = new Date();
        return d.getFullYear() + "-" + ('0' + (d.getMonth() + 1)).slice(-2) + "-" + ('0' + d.getDate()).slice(-2) + " " + ('0' + d.getHours()).slice(-2) + ":" + ('0' + d.getMinutes()).slice(-2) + ":" + ('0' + d.getSeconds()).slice(-2);
    }

    /**
     * 用es6 Set来去重
     * 注意：例如数组中同时包含 1 和 '1' 不是相同类型，所以这两个值都会被保留
     *
     * 向 Set 加入值的时候，不会发生类型转换，所以5和"5"是两个不同的值。
     * Set 内部判断两个值是否不同，使用的算法叫做“Same-value-zero equality”，它类似于精确相等运算符（===）
     *
     * unit test
     * let arr = [1, 2, '1', 0, false, undefined, 1, 1, '1', 'a', {'a': 'b'}, {'a': 'b'}];
     * unique(arr);
     * 输出      [1, 2, '1', 0, false, undefined, 'a', {'a': 'b'}, {'a': 'b'}]
     *
     * @param array
     * @returns {any[]}
     */
    function unique(array) {
        return Array.from(new Set(array));
    }
</script>
</body>
</html>